<!DOCTYPE html>
<html>
<head>
  <title>Admin</title>
  <style>
    body { font-family: Arial; background: #000; color: #fff; padding: 20px; max-width: 1000px; margin: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #333; padding: 10px; text-align: left; }
    th { background: #333; }
    .valid { color: #0f0; }
    .used { color: #f00; }
    button { background: #f00; color: #fff; border: none; padding: 5px 10px; cursor: pointer; margin: 2px; }
    button:hover { background: #cc0000; }
    button:disabled { background: #666; cursor: not-allowed; }
    input { padding: 8px; margin: 5px; background: #333; color: #fff; border: 1px solid #555; }
    .add-btn { background: #0f0; color: #000; padding: 10px 20px; font-weight: bold; }
    .add-btn:hover { background: #00cc00; }
  </style>
</head>
<body>
  <h1>üí∞ Coupon Admin</h1>
  
  <div style="margin-bottom: 20px;">
    <input id="code" placeholder="Coupon code" style="width: 200px;">
    <input id="expiry" type="date" value="2026-12-31" style="width: 180px;">
    <button class="add-btn" onclick="addCoupon()">‚ûï ADD COUPON</button>
  </div>
  
  <h2>Coupons (Auto-refresh 2s):</h2>
  <table id="table">
    <tr>
      <th>ID</th><th>Code</th><th>Status</th><th>Dealer</th><th>Expiry</th><th>Action</th>
    </tr>
  </table>

  <script>
    const auth = { headers: { 'Authorization': 'Basic ' + btoa('admin:admin123') } };
    
    async function load() {
      try {
        const res = await fetch('/coupons', auth);
        const coupons = await res.json();
        
        // Clear table
        const table = document.getElementById('table');
        table.innerHTML = `
          <tr>
            <th>ID</th><th>Code</th><th>Status</th><th>Dealer</th><th>Expiry</th><th>Action</th>
          </tr>
        `;
        
        coupons.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.id}</td>
            <td><strong>${c.code}</strong></td>
            <td class="${c.is_used ? 'used' : 'valid'}">
              ${c.is_used ? 'üõë USED' : '‚úÖ VALID'}
            </td>
            <td>${c.used_by_dealer || '-'}</td>
            <td>${c.expiry_date}</td>
            <td>
              ${!c.is_used ? 
                `<button onclick="deleteCoupon(${c.id})">üóëÔ∏è DELETE</button>` : 
                `<button disabled>Used</button>`
              }
            </td>
          `;
          table.appendChild(tr);
        });
      } catch(e) {
        console.error('Load error:', e);
      }
    }
    
    async function addCoupon() {
      const code = document.getElementById('code').value.trim();
      const expiry = document.getElementById('expiry').value;
      
      if (!code) {
        alert('Enter coupon code!');
        return;
      }
      
      try {
        const res = await fetch('/admin/coupons', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            ...auth.headers 
          },
          body: JSON.stringify({ code, expiry_date: expiry })
        });
        
        if (res.ok) {
          document.getElementById('code').value = '';
          load();
          alert('‚úÖ Coupon added!');
        } else {
          alert('‚ùå Add failed');
        }
      } catch(e) {
        alert('‚ùå Network error');
      }
    }
    
    async function deleteCoupon(id) {
      if (confirm(`Delete coupon ID ${id}?`)) {
        try {
          const res = await fetch(`/admin/coupons/${id}`, {
            method: 'DELETE',
            headers: auth.headers
          });
          
          if (res.ok) {
            load();
            alert('‚úÖ Coupon deleted!');
          } else {
            alert('‚ùå Delete failed');
          }
        } catch(e) {
          alert('‚ùå Network error');
        }
      }
    }
    
    // Load immediately + refresh every 2 seconds
    load();
    setInterval(load, 2000);
  </script>
</body>
</html>
